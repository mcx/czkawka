import { Button, CheckBox, LineEdit, ScrollView } from "std-widgets.slint";
import { Callabler } from "callabler.slint";
import { Translations } from "translations.slint";
import { ColorPalette } from "color_palette.slint";
import { FontSizes } from "fonts.slint";
import { ColumnType } from "common.slint";
import { GuiState } from "gui_state.slint";

export component PopupCustomSelect inherits Rectangle {
    out property <length> popup_width: 620px;
    out property <length> popup_height: 520px;
    callback show_popup();
    private property <bool> case_sensitive: false;
    private property <bool> leave_one_in_group: true;

    popup_window := PopupWindow {
        width: popup_width;
        height: popup_height;
        close-policy: PopupClosePolicy.no-auto-close;
        Rectangle {
            width: parent.width;
            height: parent.height;
            border-radius: 10px;
            border-color: ColorPalette.popup_border_color;
            border-width: 2px;
            background: ColorPalette.popup_background;
            clip: true;
            VerticalLayout {
                // Title bar
                Rectangle {
                    background: ColorPalette.popup_background_title_line;
                    height: 34px;
                    Text {
                        text: Translations.popup_custom_select_title_text;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                        font-size: FontSizes.normal;
                    }
                }
                // Column names
                HorizontalLayout {
                    height: 24px;
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 4px;
                    Rectangle { width: 32px; }
                    Text {
                        width: 180px;
                        text: Translations.popup_custom_column_name_header_text;
                        font-size: FontSizes.small;
                        vertical-alignment: center;
                        color: ColorPalette.hint_color;
                    }
                    Text {
                        horizontal-stretch: 1.0;
                        text: Translations.popup_custom_filter_value_header_text;
                        font-size: FontSizes.small;
                        vertical-alignment: center;
                        color: ColorPalette.hint_color;
                    }
                }
                // Scrollable column rows
                ScrollView {
                    vertical-stretch: 1.0;
                    VerticalLayout {
                        padding: 4px;
                        spacing: 2px;
                        for column[idx] in GuiState.custom_select_columns: HorizontalLayout {
                            height: 30px;
                            padding-left: 6px;
                            padding-right: 6px;
                            spacing: 4px;
                            alignment: stretch;
                            CheckBox {
                                width: 32px;
                                checked: column.enabled;
                                toggled => {
                                    Callabler.update_custom_select_column(idx, self.checked, column.filter_value);
                                }
                            }
                            Text {
                                width: 180px;
                                text: column.column_name;
                                vertical-alignment: center;
                                font-size: FontSizes.normal;
                                opacity: column.enabled ? 1.0 : 0.5;
                            }
                            LineEdit {
                                horizontal-stretch: 1.0;
                                enabled: column.enabled;
                                text: column.filter_value;
                                placeholder-text: column.column_type == ColumnType.Int
                                    ? ">= 1024  or  < 512"
                                    : column.column_type == ColumnType.Date
                                        ? ">= 2020-01-01 12:00 or 12:00 or < 30-12-2025"
                                        : column.column_type == ColumnType.FullPath
                                            ? "/home/user/*.rs  or  *backup*"
                                            : "name*  or  *.rs";
                                edited(val) => {
                                    Callabler.update_custom_select_column(idx, column.enabled, val);
                                }
                            }
                        }
                    }
                }
                // Alternative for non-implemented in slint popup hints
                Rectangle {
                    height: 84px;
                    border-width: 1px;
                    border-color: ColorPalette.popup_border_color;
                    background: ColorPalette.popup_background_title_line;
                    VerticalLayout {
                        padding: 6px;
                        spacing: 2px;
                        Text {
                            text: Translations.popup_custom_hint_str_text;
                            font-size: FontSizes.small;
                            color: ColorPalette.hint_color;
                            wrap: word-wrap;
                        }
                        Text {
                            text: Translations.popup_custom_hint_int_text;
                            font-size: FontSizes.small;
                            color: ColorPalette.hint_color;
                            wrap: word-wrap;
                        }
                        Text {
                            text: Translations.popup_custom_hint_date_text;
                            font-size: FontSizes.small;
                            color: ColorPalette.hint_color;
                            wrap: word-wrap;
                        }
                    }
                }
                // All in group and case sensitive options
                HorizontalLayout {
                    height: 36px;
                    padding-left: 10px;
                    padding-right: 10px;
                    spacing: 14px;
                    alignment: start;
                    CheckBox {
                        text: Translations.popup_custom_case_sensitive_text;
                        checked <=> case_sensitive;
                    }
                    if GuiState.tool_with_groups: CheckBox {
                        text: Translations.popup_custom_leave_one_in_group_text;
                        checked <=> leave_one_in_group;
                    }
                }
                // Buttons
                HorizontalLayout {
                    height: 46px;
                    padding: 8px;
                    spacing: 8px;
                    Button {
                        text: Translations.popup_custom_select_button_text;
                        primary: true;
                        clicked => {
                            Callabler.select_items_custom_columns(true, case_sensitive, leave_one_in_group);
                            popup_window.close();
                        }
                    }
                    Button {
                        text: Translations.popup_custom_unselect_button_text;
                        clicked => {
                            Callabler.select_items_custom_columns(false, case_sensitive, leave_one_in_group);
                            popup_window.close();
                        }
                    }
                    Rectangle { horizontal-stretch: 1.0; }
                    Button {
                        text: Translations.cancel_button_text;
                        clicked => { popup_window.close(); }
                    }
                }
            }
        }
    }
    show_popup() => {
        case_sensitive = false;
        leave_one_in_group = true;
        Callabler.populate_custom_select_columns();
        popup_window.show();
    }
}
