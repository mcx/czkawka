import { Button, ListView } from "std-widgets.slint";
import { ActiveTab, BottomPanelVisibility } from "common.slint";
import { ColorPalette } from "color_palette.slint";
import { GuiState } from "gui_state.slint";
import { Callabler } from "callabler.slint";
import { FontSizes } from "fonts.slint";
import { Translations } from "translations.slint";

component TabItem {
    in property <string> text;
    in property <ActiveTab> curr_tab;
    callback changed_active_tab();

    Rectangle {
        width: parent.width;
        horizontal-stretch: 1.0;
        background: touch-area.has-hover ? ColorPalette.tab_hovered_color : transparent;
        touch_area := TouchArea {
            clicked => {
                if (GuiState.active_tab == root.curr_tab) {
                    return;
                }
                GuiState.active_tab = root.curr_tab;
                Callabler.tab_changed();
                changed_active_tab();
            }
        }
    }

    HorizontalLayout {
        width: parent.width;
        alignment: LayoutAlignment.start;
        layout_rectangle := VerticalLayout {
            empty_rectangle := Rectangle { }

            current_rectangle := Rectangle {
                visible: (GuiState.active_tab == root.curr_tab);
                border-radius: 2px;
                width: 5px;
                height: 0px;
                background: ColorPalette.tab_selected_color;
                animate height {
                    duration: 150ms;
                    easing: ease;
                }
            }

            empty_rectangle2 := Rectangle { }
        }
    }

    Text {
        text: root.text;
        width: parent.width;
        horizontal-alignment: center;
        font-size: FontSizes.normal;
        font-weight: FontSizes.bold_light;
    }

    states [
        is-selected when GuiState.active_tab == root.curr_tab: {
            current_rectangle.height: layout_rectangle.height;
        }
        is-not-selected when GuiState.active_tab != root.curr_tab: {
            current_rectangle.height: 0px;
        }
    ]
}

export component LeftSidePanel {
    callback changed_active_tab();

    // Hidden off-screen Text elements to measure the natural width of each tool label.
    // The panel width is set to the widest one plus a small padding so that no manual
    // per-language constant is needed, like it was done in previous versions
    t_duplicate   := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_duplicate_files_text; }
    t_empty_f     := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_empty_folders_text; }
    t_big         := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_big_files_text; }
    t_empty_fi    := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_empty_files_text; }
    t_temp        := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_temporary_files_text; }
    t_sim_img     := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_similar_images_text; }
    t_sim_vid     := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_similar_videos_text; }
    t_music       := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_music_duplicates_text; }
    t_symlinks    := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_invalid_symlinks_text; }
    t_broken      := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_broken_files_text; }
    t_bad_ext     := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_bad_extensions_text; }
    t_exif        := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_exif_remover_text; }
    t_vid_opt     := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_video_optimizer_text; }
    t_bad_names   := Text { x: -10000px; y: -10000px; height: 0; font-size: FontSizes.normal; font-weight: FontSizes.bold_light; text: Translations.tool_bad_names_text; }

    property <length> max_tool_text_width:
        max(t_duplicate.preferred-width,
        max(t_empty_f.preferred-width,
        max(t_big.preferred-width,
        max(t_empty_fi.preferred-width,
        max(t_temp.preferred-width,
        max(t_sim_img.preferred-width,
        max(t_sim_vid.preferred-width,
        max(t_music.preferred-width,
        max(t_symlinks.preferred-width,
        max(t_broken.preferred-width,
        max(t_bad_ext.preferred-width,
        max(t_exif.preferred-width,
        max(t_vid_opt.preferred-width,
            t_bad_names.preferred-width)))))))))))));

    preferred-width: max_tool_text_width + 20px;
    VerticalLayout {
        spacing: 2px;
        Rectangle {
            visible: GuiState.active_tab != ActiveTab.About;
            height: 80px;
            Image {
                width: parent.height;
                source: @image-url("../icons/krokiet_logo_flag.svg");
                image-fit: ImageFit.contain;
            }

            touch_area := TouchArea {
                clicked => {
                    GuiState.active_tab = ActiveTab.About;
                    Callabler.tab_changed();
                    root.changed_active_tab();
                    GuiState.bottom_panel_visibility = BottomPanelVisibility.NotVisible;
                }
            }
        }

        ListView {
            out property <length> element_size: 25px;
            out property <[{name: string, tab: ActiveTab}]> tools_model <=> GuiState.tools_model;

            for r[idx] in tools_model: TabItem {
                height: parent.element_size;
                text: r.name;
                curr_tab: r.tab;
                changed_active_tab() => {
                    root.changed_active_tab();
                }
            }
        }

        Rectangle {
            min-width: 90px;
            HorizontalLayout {
                alignment: start;
                Button {
                    visible: GuiState.active_tab != ActiveTab.Settings;
                    min-width: 20px;
                    min-height: 20px;
                    max-height: self.width;
                    preferred-height: self.width;
                    icon: @image-url("../icons/krokiet_settings.svg");
                    colorize-icon: true;
                    clicked => {
                        GuiState.active_tab = ActiveTab.Settings;
                        Callabler.tab_changed();
                        root.changed_active_tab();
                    }
                }
            }

            HorizontalLayout {
                alignment: end;
                Button {
                    checkable: true;
                    checked: GuiState.visible_tool_settings;
                    visible: GuiState.available_subsettings;
                    min-width: 20px;
                    min-height: 20px;
                    max-height: self.width;
                    preferred-height: self.width;
                    icon: @image-url("../icons/krokiet_subsettings.svg");
                    colorize-icon: true;
                    clicked => {
                        GuiState.visible_tool_settings = !GuiState.visible_tool_settings;
                    }
                }
            }
        }
    }
}
